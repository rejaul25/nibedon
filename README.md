# Bhavki Membership Manager

A complete, production-ready membership management system with chairman dashboard, member portal, payment tracking, investment management, share calculations, and full audit history.

## Features

### Core Functionality
- **Chairman Dashboard**: Complete admin control panel for managing members, payments, investments, and viewing audit history
- **Member Portal**: Bangla-language interface for members to view their profile, payment history, and investments
- **Authentication**: Secure JWT-based authentication with httpOnly cookies and email-based password reset
- **Membership ID System**: Generate and manage unique membership IDs
- **Payment Tracking**: Record, update, and track all member payments with transaction details
- **Investment Management**: Create, update, and track organizational investments with profit/loss tracking (chairman only, members can view)
- **Audit History**: Complete tracking of all chairman actions with timestamps and change summaries
- **Share Calculations**: Automated calculations for old members, new members, and "new but full share" members
- **Email Support**: Optional email field for members with forgot password functionality
- **Password Reset**: Email-based password reset for both chairman and members with unique, time-limited tokens

### Security Features
- Auto-generated JWT secrets (no hardcoded tokens)
- bcrypt password hashing
- Rate limiting on authentication endpoints
- Input validation with Zod
- SQL injection protection
- XSS prevention
- Secure httpOnly cookies
- Password reset via email

## Technology Stack

- **Frontend**: Next.js 14 with TypeScript, Tailwind CSS
- **Backend**: Next.js API routes
- **Database**: PostgreSQL with Prisma ORM
- **Authentication**: JWT with secure httpOnly cookies
- **Validation**: Zod
- **Email**: Nodemailer
- **Testing**: Jest

## Setup Instructions

### Prerequisites
- Node.js 20 or higher
- PostgreSQL database (automatically configured on Replit)

### Installation

1. **Install dependencies**:
```bash
npm install
```

2. **Set up environment variables**:
Create a `.env` file based on `.env.example`:
```bash
# Database (automatically configured on Replit)
DATABASE_URL="postgresql://..."

# JWT Secret (auto-generated if not provided)
JWT_SECRET=""

# Chairman Account (for seeding)
CHAIRMAN_USERNAME="chairman"
CHAIRMAN_PASSWORD="admin123"
CHAIRMAN_EMAIL="chairman@bhavki.com"
CHAIRMAN_NAME="Chairman Name"
CHAIRMAN_MOBILE="01700000000"

# Email Configuration (for password reset)
SMTP_HOST="smtp.gmail.com"
SMTP_PORT="587"
SMTP_USER="your-email@gmail.com"
SMTP_PASS="your-app-password"
EMAIL_FROM="noreply@bhavki.com"
```

3. **Set up the database**:
```bash
npx prisma generate
npx prisma db push
```

4. **Seed the chairman account**:
```bash
npm run seed:init
```

5. **Optional: Seed sample data**:
```bash
npm run seed:sample
```

## How to Run

### Development Mode
```bash
npm run dev
```
The application will be available at `http://localhost:5000`

### Production Mode
```bash
npm run build
npm start
```

### Run Tests
```bash
npm test
```

## How to Use

### Chairman Access

1. **Login**: Navigate to `/chairman/login`
   - Username: Use the `CHAIRMAN_USERNAME` from your `.env` file (default: `chairman`)
   - Password: Use the `CHAIRMAN_PASSWORD` from your `.env` file (default: `admin123`)
   - **⚠️ IMPORTANT**: Change the default password after first login!

2. **Forgot Password**: Click "Forgot Password?" on the login page
   - Requires SMTP configuration in `.env` file
   - Reset link will be sent to `CHAIRMAN_EMAIL`
   - Link expires in 1 hour

3. **Dashboard Features**:
   - **Members Tab**: Manage all members
     - Generate membership IDs
     - Create new members (select "Full Share" or "New Member", optional email field)
     - Search members by name or membership ID
     - Edit member details including email (membership ID cannot be changed)
     - Delete members (cascades to payments, marks membership ID as unusable)
   - **Payments Tab**: Record and manage payments
     - Create single or bulk payments
     - Update payment details including transaction number
     - View all payment history
   - **Investments Tab**: Manage organizational investments
     - Create new investments (title, description, amount, purpose)
     - Update investment details including status, profit/loss, and reason
     - Track investment performance (profit or loss)
     - Delete investments
   - **Audit Tab**: View complete history of all chairman actions

### Member Access

1. **Registration**: Navigate to `/member/register`
   - Requires a valid membership ID (generated by chairman)
   - Fill in: Name (নাম), Father's Name (পিতার নাম), Mobile (মোবাইল নম্বর), Email (ইমেইল - optional), Password (পাসওয়ার্ড)
   - Email is optional but **required for password reset functionality**
   - Membership ID can only be used once
   - After successful registration, automatically redirected to login

2. **Forgot Password**: Click "পাসওয়ার্ড ভুলে গেছেন?" on the login page
   - Requires email address provided during registration
   - Reset link will be sent to registered email
   - Link expires in 1 hour
   - **Note**: Only available if email was provided during registration

3. **Login**: Navigate to `/member/login`
   - Membership ID (মেম্বারশিপ আইডি)
   - Password (পাসওয়ার্ড)

4. **Dashboard Features**:
   - **Profile**: View personal information including email (if provided)
   - **Payment History**: Complete timeline of all payments with scrollable view (max 7 visible at once)
   - **Investments**: View all organizational investments with profit/loss details

## Share Calculation Formulas

### Formula Explanation (English & Bangla)

#### For Old (Full Share) Members:
**Formula**: `share = 500 × months_paid × 100 / (total_shares × total_months) × 500`

**English**: An old member's share is calculated based on their months of payment relative to the total share-months of all full-share members.

**বাংলা**: পুরাতন সদস্যদের শেয়ার তাদের মোট পেমেন্ট মাস এবং সকল ফুল শেয়ার সদস্যদের মোট শেয়ার-মাসের ভিত্তিতে গণনা করা হয়।

#### For New Members:
**Formula**: `share = 500 × months_paid × 100 / (previous_total + new_month_total)`

**English**: A new member's share is calculated based on their contribution relative to the total accumulated funds (previous + current).

**বাংলা**: নতুন সদস্যদের শেয়ার তাদের অবদান এবং মোট সংগৃহীত তহবিলের (পূর্বের + বর্তমান) ভিত্তিতে গণনা করা হয়।

#### For "New but Full Share" Members:
**English**: When creating a member as "New but Full Share", the system automatically calculates the required upfront payment: `500 × (months existing members have paid)`. This payment is recorded automatically, giving them equal standing with existing full-share members.

**বাংলা**: "নতুন তবে ফুল শেয়ার" সদস্য তৈরি করার সময়, সিস্টেম স্বয়ংক্রিয়ভাবে প্রয়োজনীয় অগ্রিম পেমেন্ট গণনা করে: `৫০০ × (বিদ্যমান সদস্যদের পেমেন্ট মাস সংখ্যা)`। এই পেমেন্ট স্বয়ংক্রিয়ভাবে রেকর্ড হয়, যা তাদের বিদ্যমান ফুল শেয়ার সদস্যদের সমান মর্যাদা দেয়।

## API Endpoints

### Authentication
- `POST /api/auth/chairman/login` - Chairman login
- `POST /api/auth/chairman/forgot-password` - Request password reset
- `POST /api/auth/reset-password` - Reset password with token
- `POST /api/auth/member/register` - Member registration (requires valid membership ID)
- `POST /api/auth/member/login` - Member login
- `POST /api/auth/logout` - Logout (clears cookie)
- `GET /api/auth/me` - Get current user info

### Membership IDs
- `POST /api/membership-ids/generate` - Generate membership IDs (chairman only)

### Members
- `GET /api/members` - List all members with search and pagination (chairman only)
- `POST /api/members` - Create new member (chairman only)
- `GET /api/members/[id]` - Get member details (owner or chairman)
- `PUT /api/members/[id]` - Update member (owner or chairman)
- `DELETE /api/members/[id]` - Delete member with cascade (chairman only)

### Payments
- `GET /api/payments` - List all payments (chairman only)
- `POST /api/payments` - Create payment (chairman only)
- `PUT /api/payments/[id]` - Update payment including transaction number (chairman only)
- `GET /api/payments/member/[membershipId]` - Get member payments (owner or chairman)

### Investments
- `GET /api/investments` - List all investments (all authenticated users)
- `POST /api/investments` - Create investment (chairman only)
- `PUT /api/investments/[id]` - Update investment (chairman only)
- `DELETE /api/investments/[id]` - Delete investment (chairman only)

### Reports & Audit
- `GET /api/reports/share` - Get share calculations for all members
- `GET /api/audit-logs` - View audit history (chairman only)

## Database Schema

### User
- Stores both chairman and members
- `membershipId`: Unique, immutable identifier
- `role`: chairman | member
- `shareType`: fullShare | newMember (for members only)
- `isDeleted`: Soft delete flag

### Payment
- Linked to member via `membershipId`
- Tracks: amount, date, payment method, transaction number
- `updatedBy`: Tracks who made edits (audit trail)
- Cascade deletes when member is deleted

### MembershipId
- Pool of generated membership IDs
- `assignedTo`: Links to user when used
- `isDeleted`: Prevents reuse of deleted member IDs

### Investment
- Organizational investments
- Viewable by all members, editable by chairman only
- Tracks: title, description, amount, date, purpose

### AuditLog
- Complete history of all chairman actions
- Tracks: action type, performer, target, changes, metadata
- Immutable record

### PasswordResetToken
- For chairman password recovery
- Tokens expire in 1 hour
- One-time use only

## Important Notes

### Member Deletion
When a chairman deletes a member:
1. User record is soft-deleted (`isDeleted = true`)
2. All payment records are cascade deleted
3. Membership ID is marked as deleted (`isDeleted = true`)
4. **The membership ID becomes permanently unusable** and cannot be reassigned

### Payment Editing
- Chairman can edit **any field** of any payment at any time
- Common use case: Adding transaction number to existing payments
- All edits are tracked in the audit log with:
  - Who made the change
  - When it was changed
  - What was changed (before → after)

### Share Type Selection
When creating a member, chairman selects:
- **Full Share**: For members joining with equal status (auto-calculates upfront payment)
- **New Member**: For members starting fresh with gradual contribution

### JWT Secret
- If `JWT_SECRET` is not provided in `.env`, one will be auto-generated
- **For production**: Always set a permanent `JWT_SECRET` in your environment
- Auto-generated secrets will change on restart, invalidating all sessions

### Email Configuration
- Required for chairman password reset
- Use Gmail App Passwords or other SMTP service
- Without email config, forgot-password feature won't work

## Development

### Project Structure
```
├── pages/
│   ├── api/              # API routes
│   ├── chairman/         # Chairman pages
│   ├── member/           # Member pages
│   └── index.tsx         # Homepage
├── lib/                  # Utilities
│   ├── prisma.ts         # Database client
│   ├── jwt.ts            # JWT utilities
│   ├── auth.ts           # Auth helpers
│   ├── share-calculator.ts
│   ├── audit.ts
│   ├── email.ts
│   ├── rate-limiter.ts
│   └── validation.ts
├── prisma/
│   └── schema.prisma     # Database schema
├── scripts/              # Seed scripts
└── __tests__/            # Jest tests
```

### Environment Variables
See `.env.example` for all available configuration options.

### Database Migrations
This project uses Prisma's push workflow:
```bash
npx prisma db push
```

For production, consider using migrations:
```bash
npx prisma migrate dev
```

## Security Considerations

1. **Always change default chairman password** after first login
2. **Set a strong JWT_SECRET** in production
3. **Configure rate limiting** appropriately for your environment
4. **Use HTTPS** in production
5. **Secure your SMTP credentials**
6. **Regularly review audit logs** for suspicious activity
7. **Keep dependencies updated** for security patches

## Troubleshooting

### Chairman Cannot Login
- Verify chairman account was created: `npm run seed:init`
- Check username/password match `.env` values
- Clear browser cookies and try again

### Member Registration Fails
- Ensure membership ID was generated by chairman
- Check that membership ID hasn't been used before
- Verify membership ID hasn't been marked as deleted

### Forgot Password Not Working
- Verify SMTP configuration in `.env`
- Check email spam folder
- Ensure `CHAIRMAN_EMAIL` is correct
- Check server logs for email errors

### Database Connection Issues
- Verify `DATABASE_URL` is correct
- Run `npx prisma db push` to sync schema
- Check PostgreSQL service is running

## License

This project is proprietary software for Bhavki Membership Manager.

## Support

For issues or questions, contact the system administrator.

---

**Last Updated**: November 2025
**Version**: 1.0.0
